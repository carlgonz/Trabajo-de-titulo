\chapter{Pruebas y resultados}\label{ch5}
En este capítulo se detallan y discuten los resultados obtenidos luego de la implementación del sistema. Se analiza el funcionamiento del satélite con sus tres sistemas básicos integrados donde se realiza una revisión de cumplimiento de estándares y funcionalidades esperadas por el equipo que dirige el proyecto SUCHAI.
Se realizan pruebas de rendimiento y estadisicas del uso de los recursos de \textit{hardware} para determinar si la solución es adecuada para la plataforma objetivo.

\section{Pruebas de rendimiento}
\subsection{Estadísticas del programa}
Mediante las herramientas que provee el IDE MPLABX se obtienen diferentes estadísticas sobre el código que se ha programado como una medida básica de la envergadura del proyecto lo cual se muestra en la tabla \ref{ch5:table:code_stats}.

\begin{table}[h]\caption{Estadísticas del código}
\centering
\begin{tabular}{ll}
\hline
\textbf{Lineas de código} & 17475 \\
\textit{\textbf{Commits}} & 986   \\
\textit{\textbf{Tags}}    & 2     \\
\textbf{Contribuyentes}   & 4     \\
\textbf{Comandos}         & 107   \\ \hline
\end{tabular}\label{ch5:table:code_stats}
\end{table}

\subsection{Estadísticas de uso de memoria}
A continuación se detallan las estadísticas de uso de memoria de programa y datos que utiliza el \textit{software} al ser compilado y programado en el microcontrolador, los resultados se detallan en la tabla \ref{ch5:table:memoria}

\begin{table}[h]\caption{Uso de memoria de la aplicación}
\centering
\begin{tabular}{llll}
\hline
\textbf{Memoria} & \textbf{Usada [bytes]} & \textbf{Total [bytes]} & \textbf{Porcentaje de uso}                   \\ \hline
RAM              & 9688                   & 16384                  & 59\% \\
FLASH            & 37566                  & 87548                  & 43\% \\ \hline
\end{tabular}\label{ch5:table:memoria}
\end{table}

Lo anterior demuestra que la solución programada se ajusta a la disponibilidad de memoria de datos y de programa disponibles. A pesar de reducida cantidad de memoria de programa disponible aún queda más del 50\% libre para programar más comandos y nuevas funcionalidades. Lo más crítico es la memoria RAM que se encuentra utilizada en cerca del 60\% lo cual podría ver reducida la capacidad de agregar nuevos \textit{listeners}.

Otro punto importante a considerar es la cantidad de memoria asignada al sistema operativo y la configuración de memoria de \textit{stack} que se ha asignado a las diferentes tareas. Si la memoria no es suficiente se pueden generar condiciones de \textit{stack overflow} que dejarían al sistema inestable o no funcional. La asignación de memoria de las tareas se realiza de manera experimental según los requerimientos de la aplicación\cite{FREERTOS_PIC24} y para comprobar que no existen problemas se realiza la tabla \ref{ch5:table:memoria_freertos} a partir de la salida de depuración que provee el entorno de desarrollo.

\begin{table}[h]\caption{Uso de memoria del sistema operativo}
\centering
\begin{tabular}{lllll}
\hline
\multirow{2}{*}{\textbf{Tarea}} & \multirow{2}{*}{\textbf{Prioridad}} & \multicolumn{3}{c}{\textbf{Memoria [bytes]}}                                                                                \\ \cline{3-5} 
                                &                                     & \multicolumn{1}{c}{\textbf{Asignada}} & \multicolumn{1}{c}{\textbf{Usada}} & \multicolumn{1}{c}{\textbf{Porcentaje de uso}} \\ \hline
idle                            & 0                                   & 115                                   & 79                                 & 69\%                                            \\
flightplan                      & 2                                   & 230                                   & 145                                & 63\%                                            \\
communications                  & 2                                   & 230                                   & 125                                & 54\%                                            \\
console                         & 2                                   & 230                                   & 91                                 & 39\%                                            \\
housekeeping                    & 2                                   & 230                                   & 97                                 & 42\%                                            \\
dispatcher                      & 3                                   & 230                                   & 109                                & 47\%                                            \\
executer                        & 4                                   & 575                                   & 85                                 & 14\%                                            \\ \hline
\end{tabular}\label{ch5:table:memoria_freertos}
\end{table}

La tabla demuestra que la asignación de memoria de las tareas es la correcta en cuanto ninguna está utilizando la totalidad de la memoria. La cantidad de memoria utilizada por una tarea es una variable dinámica que depende de las acciones concretas que esta ejecutando la aplicación por lo que siempre se debe dejar un margen de seguridad en la asignación. El caso mas crítico es el \textit{executer} debido a que ejecuta una variedad de comandos por lo tanto el dato mostrado en la tabla \ref{ch5:table:memoria_freertos} no es confiable y se debe asignar la mayor cantidad de memoria de \textit{stack} posible para evitar que algún comando cause \textit{stack overflow}.

%TODO: Estadisticas de eso de procesador

%\section{Pruebas de arquitectura}
%TODO Diagrama con la arquitectura y las salidas

\section{Pruebas de integración}
Con las pruebas de integración se busca determinar el cumplimiento de los requerimientos operacionales del proyecto, especialmente aquellas capacidades que dependen directamente de la implementación del software de vuelo. Para esto se han integrado los tres sub-sistemas básicos del satélite (computador a bordo, energía y comunicaciones) y el sistema se hace funcionar durante un tiempo prolongado simulando condiciones de operación nominales siguiendo la técnica denominada \textit{hardware in the loop simulation} común en las pruebas de sistemas embebidos complejos.

\subsection{Configuración}

Las herramientas utilizadas para el desarrollo de la prueba consisten en:
\begin{itemize}
    \item Entorno de prueba
    \begin{itemize}
        \item Caja limpia para albergar el satélite.
        \item Computador para registro de datos.
        \item Programador Microchip ICD3.
        \item Cable USB para comunicación serial.
        \item Equipo de radio portátil Alinco XXX.
        \item Cámara de video para registro de la prueba.
        \item Multímetro.
    \end{itemize}

    \item Estación terrena
    \begin{itemize}
        \item Antena 50$\Omega$ de baja ganancia.
        \item Equipo de radio ICOM 910.
        \item Computador para capturar y procesar audio.
    \end{itemize}
    
    \item Satélite
    \begin{itemize}
        \item Computador a bordo con placa madre CubesatKit rev. D y módulo de procesador CubesatKit D1 con PIC24F256GA110.
        \item EPS CS-1UEPS2-NB ClydeSpace
        \item Transceptor AllSpace ASCOM-01 rev. 3
        \item Paneles solares.
    \end{itemize}
\end{itemize}

El montaje de la prueba se muestra en la figura \ref{ch4:test:montaje} y consiste en mantener el satélite dentro de la cámara limpia conectado a través de un cable USB al computador que registrará los resultados de la prueba y enviar comandos al software de vuelo. Este cable también provee de alimentación al sistema de energía para la carga de las baterías, se utilizará un multímetro para monitorear su voltaje además de los registros generados por el software de vuelo. La radio portátil se utiliza para una rápida verificación del funcionamiento del sistema de comunicaciones y permite detectar si se produce alguna transmisión durante el periodo de inactividad obligatorio. La estación terrena está configurada para escuchar el sistema de comunicaciones del satélite con el software para decodificar su baliza y telemetría. El satélite a través del software de vuelo funciona de manera autónoma y la interfaz de \textit{debug} sólo se utilizará para registrar información útil para la prueba.

%···················· FIGURE ····················
\begin{figure}[ht!] \centering
\subfloat[Montaje del satélite]{\includegraphics[width=0.45\textwidth]{img/test_montaje.jpg}}
\hspace{0.3cm}
\subfloat[Estación terrena]{\includegraphics[width=0.45\textwidth]{img/test_groundstation.jpg}}
\caption{Montaje de la prueba de integración}\label{ch4:test:montaje}
\end{figure}
%················································

Del desarrollo de la prueba consiste de los siguientes pasos.
\begin{itemize}
    \item Configurar el software de vuelo y programar el computador a bordo.
    \item Llevar al software de vuelo al estado de 'primer encedido'.
    \item Comenzar el registro de la consola serial.
    \item Monitorear el cumplimiento del periodo de inactividad.
    \item Monitorear el correcto despliegue de antenas.
    \item Monitorear la correcta inicialización del software de vuelo.
    \item Registrar los comandos ejecutados en el software de vuelo.
    \item Registrar periódicamente el valor de las variables de estado.
    \item Registrar periódicamente los registros de la EPS.
    \item Recibir el \textit{beacon} emitido en la estación terrena.
    \item Enviar una señal de radio para activar el envío de telemetría.
    \item Recibir la telemetría enviada en la estación terrena.
    \item Ejecutar test de reinicio.
    \item Ejecutar test de falla de software.
    \item Ejecutar test de energía baja.
\end{itemize}

Los resultados de la prueba se obtendrán en la forma de:
\begin{itemize}
    \item Archivo de texto con el registro de la consola serial.
    \item Texto y audio del beacon recibido en la estación terrena.
    \item Datos de la telemetría decodificada en la estación terrena.
    \item Imágenes del proceso de despliegue de antena.
\end{itemize}

\subsection{Resultados}
Los resultados serán analizados para cada requerimiento operacional correspondiente al software de vuelo producto del correspondiente análisis de las salidas generadas en la prueba de funcionamiento del satélite integrado.

\subsubsection{Área de comunicaciones}
\paragraph{Configuración inicial del \textit{transcevier}.}
La configuración inicial del transcevier se lleva a cabo durante el proceso de inicio del software de vuelo, esto se observa en el registro de la consola que indica la ejecución del comando \texttt{trx\_initialize} que incluye la configuración del \textit{beacon} por defecto mediante el comando \texttt{trx\_setbeacon}:

\begin{verbatim}
* Setting TRX
  Setting beacon: SUCHAIATINGDOTUCHILEDOTCL-
  >> TRX Setting BEACON:
       Setting Offset...
       Setting Content...
       Setting Beacon Length... 26
\end{verbatim}

La correcta configuración del transcevier se comprueba leyendo los registros internos de configuración del equipo una vez que el satélite está funcionando en régimen normal. La tabla \ref{ch5:table:result:trx} muestra el valor por defecto de los registros del transcevier, el valor configurado y su valor leído.

%TODO: Tabla con los registros del TRX

El software puede configurar diferentes parámetros del sistema de comunicaciones, un ejemplo de ello es la la cantidad de palabras por minuto del \textit{beacon} CW de transmisión. Diferentes configuraciones para esta variable fueron configurados al inicio del sistema el resultado se observa en la estación terrena a través del software MixW como se muestra en la figura \ref{ch5:result:bcn_pwr}

%TODO: Imagen del beacon a diferentes potencias

El silencio radial se lleva a cabo configurando el transcevier en modo silencioso al inicio del sistema y como medida adicional se evita la generación de cualquier transmisión inhibiendo la ejecución de cualquier comando durante el periodo de inactividad. Durante la prueba se mantiene cerca la radio portátil para detectar cualquier transmisión así como para generar intentos de comunicación con el satélite que no deben tener respuesta. El resultado se detalla en registro de la consola que revela que en efecto ningún comando de transmisión de datos se efectúa durante el periodo de inactividad radial:

\begin{verbatim}
[2013-08-29 16:35:23.046699] [dep_silent_time] Mandatory inactivity time...
[2013-08-29 16:35:23.081650]     First time on. Antenna NOT deployed
[2013-08-29 16:35:23.095963]     STARTING 30MIN SILENT TIME
[2013-08-29 16:35:23.120451]     * Turning off TX    
[2013-08-29 16:35:23.131351]     * System halted at >>[29/8/13 - 16:35:31]
[2013-08-29 17:07:04.564344]     * 65[s] remaining ...
[2013-08-29 17:08:10.107138]     * System resumed at >>[29/8/13 - 17:8:17]
[2013-08-29 17:08:10.143954]     FINISHING SILENT TIME
\end{verbatim}

\paragraph{Despliegue de antenas.}
El despliegue de antenas está a cargo de la secuencia de inicio del software de vuelo que activa y controla el sistema de despliegue. El proceso queda registrado en la consola donde en este caso luego del séptimo intento de despliegue se detecta que el \textit{switch} indicador del despliegue se ha liberado continuando con el inicio del sistema.

\begin{verbatim}
[2013-08-29 17:08:10.163688] [dep_deploy_antenna] Deploying TRX Antenna... 
[2013-08-29 17:08:10.201290]     [Deploying] Attempt #1
[2013-08-29 17:11:21.425436]     [Deploying] Attempt #2
[2013-08-29 17:14:32.682874]     [Deploying] Attempt #3
[2013-08-29 17:17:43.940662]     [Deploying] Attempt #4
[2013-08-29 17:20:55.198422]     [Deploying] Attempt #5
[2013-08-29 17:24:06.456182]     [Deploying] Attempt #6
[2013-08-29 17:27:17.713377]     [Deploying] Attempt #7
[2013-08-29 17:30:30.970832]     ANTENNA DEPLOYED SUCCESSFULLY [7 TRIES]
\end{verbatim}

En la figura \ref{ch5:result:antenna} se observan las antenas antes  y después del proceso de despliegue.

%···················· FIGURE ····················
\begin{figure}[ht!] \centering
\subfloat[Previo al despliegue]{\includegraphics[width=0.45\textwidth]{img/test_deploy_pre.jpg}}
\hspace{0.3cm}
\subfloat[Antenas desplegadas]{\includegraphics[width=0.45\textwidth]{img/test_deploy_post.jpg}}
\caption{Despliegue de antenas}\label{ch5:result:antenna}
\end{figure}
%················································

\paragraph{Procesamiento de telecomandos.}
Utilizando el software de control de la estación terrena para el \textit{transcevier} del satélite se generaron secuencias de comandos que el software de vuelo debe decodificar y ejecutar. La secuencia de comandos generados es: imprimir la hora del sistema, imprimir las variables de estado y enviar las variables de estado como telemetría. Esto se traduce en el siguiente telecomando:

\begin{verbatim}
    <cmd1> <para> <cmd2> <para> <stop>
    0x5008 0x0000 0x8003 0x0000 0xFFFE
\end{verbatim}

Se observa en la figura \ref{ch5:result:telecomandos} el software control con la secuencia de comandos en proceso de envío.

%TODO: Imagen con el telecomando

El resultado de esta prueba no es satisfactorio debido a que el satélite no es capaz de recibir los telecomandos enviados producto a una falla del equipo de comunicaciones a bordo. Los detalles de esta falla se detallan en la sección \ref{ch5:fallas:telecomandos}

\paragraph{Protocolo de enlace.}
El software de vuelo se encarga de generar \textit{beacons} de maneara periódica que permiten identificar al satélite y contienen información valiosa sobre su funcionamiento. Cada cuatro minutos y de manera intercalada se generan dos tipos de \textit{beacon}: uno simple que contiene sólo un identificador; y un segundo más largo que agrega el valor de algunas variables de estado de interés. Esto se observa en los registros de la consola:

\begin{verbatim}
[2013-08-29 17:34:36.705630] >>Beacon:SUCHAIATINGDOTUCHILEDOTCL-0
[2013-08-29 17:34:36.722492] >> TRX Setting BEACON:
[2013-08-29 17:34:36.736283]       Setting Offset...
[2013-08-29 17:34:36.873040]       Setting Content... 
[2013-08-29 17:34:40.890843]       Setting Beacon Length... 27
...
[2013-08-29 17:38:36.710971] >>Beacon:SUCHAIATINGDOTUCHILEDOTCL-11000017H30761940780001
[2013-08-29 17:38:36.741475] >> TRX Setting BEACON:
[2013-08-29 17:38:36.761285]       Setting Offset...
[2013-08-29 17:38:36.910411]       Setting Content... 
[2013-08-29 17:38:44.190745]       Setting Beacon Length... 49
\end{verbatim}

A los cuatro minutos de funcionamiento se genera el primer \textit{beacon} cuyo contenido es: \texttt{SUCHAIATINGDOTUCHILEDOTCL-0}. Eso es el identificador seguido de un guión y un número que indica que este mensaje no tiene más información. 

El siguiente beacon corresponde al texto: \texttt{SUCHAIATINGDOTUCHILEDOTCL-11000017H30761940780001} e incluye variables de estado en su contenido.

Para comprobar el correcto funcionamiento del la lógica que genera la información de cada beacon se realiza la tabla \ref{ch5:table:result:beacon} de comparación entre el contenido generado y el valor de las variables de estado en ese momento para una secuencia de beacons.

\begin{table}[h]\caption{Beacons generados por el software de vuelo}
\begin{tabular}{lllllllll}
\hline
\textbf{Parámetro}       & \textbf{Estado} & \textbf{Beacon} & \textbf{Estado} & \textbf{Beacon} & \textbf{Estado} & \textbf{Beacon} \\ \hline
Hora del registro        & \multicolumn{2}{c}{18:34:36}      & \multicolumn{2}{c}{19:38:36}      & \multicolumn{2}{c}{20:11:37}      \\
Modo de operación        & 1  & 1  & 1  & 1  & 1  & 1  \\
Horas sin reset          & 1  & 1  & 2  & 2  & 0  & 0  \\
Contador de reset        & 0  & 0  & 0  & 0  & 7  & 7  \\
Antena desplegada        & 1  & 1  & 1  & 1  & 1  & 1  \\
Intentos de despliegue   & 7  & 7  & 7  & 7  & 7  & 7  \\
Hora de despliegue       & 17 & H  & 17 & H  & 17 & H  \\
Minuto de despliegue     & 30 & 30 & 30 & 30 & 30 & 30 \\
Voltaje baterías [V]     & 7,70642 & 7,7     & 7,80971 & 7,8     & 7,64069 & 7,6     \\
Temperatura baterías [C] & 19,873  & 19 & 19,873  & 19 & 18,406  & 18 \\
Nivel de carga [SOC]     & 5  & 5  & 6  & 6  & 4  & 4  \\
Baterías cargando        & 1  & 1  & 1  & 1  & 0  & 0  \\
Promedio RSSI [dBm]      & -51     & -78     & -54     & -78     & -52     & -78     \\
Contador de TM           & 0  & 0  & 0  & 0  & 0  & 0  \\
Contador de TC           & 0  & 0  & 0  & 0  & 0  & 0  \\
Estado memoria SD        & 1  & 1  & 1  & 1  & 1  & 1  \\ \hline
\end{tabular}\label{ch5:table:result:beacon}
\end{table}

Con esto se concluye que la lógica que permite rastrear al satélite y recuperar información esencial de su funcionamiento actúa según lo esperado. 

En la estación terrena se reciben estas señales y son procesadas por el software de la estación que permite decodificar el código morse. Un ejemplo de la señal recibida en la estación terrena se muestra en la figura \ref{ch5:result:beacon}.

%···················· FIGURE ····················
\begin{figure}[ht!] \centering
\subfloat[Beacon 1]{\includegraphics[width=0.45\textwidth]{img/beacon1.png}}
\hspace{0.3cm}
\subfloat[Beacon 2]{\includegraphics[width=0.45\textwidth]{img/beacon2.png}}
\caption{Beacon recibido en la estación terrena}\label{ch4:result:antenna}
\end{figure}
%················································

Los textos obtenidos para una secuencia de tres \textit{beacons} transmitidos fueron:

\begin{verbatim}
O0000V0000000XHX02000000000000000GBW00000000DK000024 
O0000V0000000XHX02000000000000000GBW00000000DK000025 
O0000V0000000XHX02000000000026
\end{verbatim}

Lo cual claramente significa una falla en el sistema debido a que no se recibe el texto esperado. El análisis de esta falla se explica en detalle en la sección \ref{ch5:fallas:beacon} y se debe a un error del equipo de comunicaciones al configurar el nuevo texto del \textit{beacon}; se descarta errores en la estación terrena debido a que la secuencia decodificada tiene sentido lo que se observa en el contador que automáticamente el \textit{transcevier} agrega a al final de la secuencia y el cero siempre presente al inicio.

El protocolo de enlace, una vez identificado el satélite implica enviar una señal al satélite para iniciar la descarga de datos o ejecutar telecomandos. Debido a las fallas en el equipo de comunicaciones que no permite la recepción de telecomandos el satélite funciona un modo de respaldo en el cual ante la presencia de un nivel fuerte de señal en la banda asignada durante al menos 10 segundos este inicia la descarga de datos recolectados.

El sistema reacciona ante la emisión de la señal portadora en la frecuencia asignada por parte del equipo de radio portátil y comienza una cuenta con los segundos que la señal está presente, prueba de ello es el registro generado:

\begin{verbatim}
[2013-08-29 19:37:55.076357] RSSI_CNT=2
[2013-08-29 19:37:57.480979] RSSI_CNT=4
[2013-08-29 19:37:59.055074] RSSI_CNT=6
[2013-08-29 19:38:01.055657] RSSI_CNT=8
[2013-08-29 19:38:03.063135] RSSI_CNT=10
\end{verbatim}

Cuando se superan los 10 segundos y se detecta la ausencia de señal se produce la inmediata descarga de la telemetría almacenada en el satélite. En la consola se observa este proceso:

\begin{verbatim}
[2013-08-29 19:38:05.055308] RSSI_CNT=12
[2013-08-29 19:38:07.107302] com_doOnRSSI..
[2013-08-29 19:38:07.116383] [Dispatcher] Orig: 0x1102 | Cmd: 0x8003 | Param: 2
[2013-08-29 19:38:07.191023] >> Sending START_WRITE_TM command... [OK]
[2013-08-29 19:38:08.990042] >>Sending START_SEND_TM command...
[2013-08-29 19:38:09.769988] >> Telemetry transmited [OK]
[2013-08-29 19:38:09.790260] >> Sending START_WRITE_TM command...[OK]
[2013-08-29 19:38:12.316259] >>Sending START_SEND_TM command...
[2013-08-29 19:38:13.104915] >> Telemetry transmited [OK]
\end{verbatim}

Asimismo en la estación terrena se recibe la señal proveniente del satélite y el software decodifica los datos el resultado en pantalla como se muestra en la figura \ref{ch5:result:telemetria}.

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/test_telemetria.png}{width=0.8\textwidth}{Recepción de telemetría en la estación terrena}{ch5:result:telemetria}{hb!}

\paragraph{Envío de telemetría.}
El envío de telemetría es activado desde la estación terrena por alguno de los siguientes métodos dependiendo del modo de funcionamiento del software de vuelo:

\begin{itemize}
    \item \textbf{Modo normal:} la telemetría se descarga bajo demanda como resultado de la ejecución de un telecomando. Se pueden ejecutar telecomandos para descargar telemetría de manera selectiva
    
    \item \textbf{Modo de respaldo:} si no se reciben telecomandos durante un periodo de tiempo determinado (por ejemplo 24 horas) se asume una falla en el sistema de comunicaciones y se puede transmitir provocar una transmisión de telemetría sólo al recibir la señal de la portadora durante una cantidad de tiempo determinada (por ejemplo 10 segundos). No se puede seleccionar el tipo de telemetría a descargar sino que se envían todos los datos recolectados hasta el momento.
\end{itemize}

Durante la prueba sólo estuvo disponible el modo de respaldo por lo que se transmite la portadora durante el tiempo especificado en la configuración del software, en este caso de 10 segundos. El satélite detecta la señal y el software realiza el conteo mientras está presente como se observa en el registro:

\begin{verbatim}
[2013-08-29 19:37:55.076357] RSSI_CNT=2
[2013-08-29 19:37:57.480979] RSSI_CNT=4
[2013-08-29 19:37:59.055074] RSSI_CNT=6
[2013-08-29 19:38:01.055657] RSSI_CNT=8
[2013-08-29 19:38:03.063135] RSSI_CNT=10
[2013-08-29 19:38:05.055308] RSSI_CNT=12
[2013-08-29 19:38:07.107302] com_doOnRSSI..
[2013-08-29 19:38:07.116383] [Dispatcher] Orig: 0x1102 | Cmd: 0x8003 | Param: 2
[2013-08-29 19:38:07.191023] >> Sending START_WRITE_TM command... [OK]
[2013-08-29 19:38:08.990042] >>Sending START_SEND_TM command...
[2013-08-29 19:38:09.769988] >> Telemetry transmited [OK]
[2013-08-29 19:38:09.790260] >> Sending START_WRITE_TM command...[OK]
[2013-08-29 19:38:12.316259] >>Sending START_SEND_TM command...
[2013-08-29 19:38:13.104915] >> Telemetry transmited [OK]
\end{verbatim}

Esto provoca el envío de toda la telemetría almacenada, que corresponde al valor de las variables de estado registradas cada 20 minutos. En la estación terrena se reciben estos datos decodificados por el software del TNC y los resultados se detallan en la figura \ref{ch5:result:telemetria}

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/test_telemetria.png}{width=0.8\textwidth}{Recepción de telemetría en la estación terrena}{ch5:result:telemetria}{hb!}

Se observa que a pesar de las fallas en el sistema de comunicaciones el software de vuelo puede ejecutar la descarga de telemetría operando en modo de respaldo. AL igual que el \textit{beacon} la señal es recibida pero por fallas en el equipo abordo de satélite los datos son recibidos correctamente y el software indica un error en la decodificación de los datos.

\subsubsection{Control central}
\paragraph{Organizar telemetría.}
Durante la misión se generarán datos que provienen de diferentes subsistemas o \textit{payloads}. Se debe contar con un medio de almacenamiento con la capacidad adecuada para mantener estos datos y un sistema de organización de los diferentes datos guardados con el objetivo de ser requeridos de manera selectiva para ser enviados como telemetría a la estación terrena.

\paragraph{Plan de vuelo.}
El plan de vuelo está a cargo del \textit{listener} \texttt{taskFlightPlan} que de manera periódica consulta la lista de comandos manejada por el repositorio de datos y determina el siguiente comando que se debe ejecutar.

El plan de vuelo consiste en una lista de comandos a ejecutar y su parámetro durante 24 horas con espacio de 10 minutos entre cada uno aunque este parámetro es configurable. El módulo \texttt{taskFlightPlan} realiza un mapeo entre la hora actual del sistema y el indice que corresponde a leer desde el plan de vuelo. Se configura al inicio del sistema según sea necesario y para efectos de esta prueba se genera el itinerario de la tabla \ref{ch5:table:result:flightplan}:

\begin{table}[ht!] \caption{Plan de vuelo}
\centering
\begin{tabular}{llll}\hline
\textbf{Hora} & \textbf{Comando} & \textbf{Código} & \textbf{Parámetro}\\\hline
00:00 & rtc\_print & 0x7007 & 0\\
00:10 & pay\_FSM\_default & 0x6001 & dat\_pay\_tmEstado\\
00:20 & rtc\_print & 0x7007 & 0\\
00:30 & pay\_FSM\_default & 0x6001 & dat\_pay\_tmEstado\\
... & ... & ... & ...\\\hline
\end{tabular} \label{ch5:table:flightplan}
\end{table}

El correcto funcionamiento de este módulo se comprueba a través de los registros de la consola, que cuentan con una estampa de tiempo para determinar la frecuencia y momento de ejecución de los comandos producidos por el plan de vuelo. A continuación se observa el resultado de la ejecución del comando \texttt{rtc\_print} proveniente del plan de vuelo:

\begin{verbatim}
[2013-08-29 17:40:06.811852] [Dispatcher] Orig: 0x1103 | Cmd: 0x7007 | Param: 0
[2013-08-29 17:40:06.837689] >>[29/8/13 - 17:40:14]
[2013-08-29 18:00:06.914741] [Dispatcher] Orig: 0x1103 | Cmd: 0x7007 | Param: 0
[2013-08-29 18:00:06.969861] >>[29/8/13 - 18:00:14]
[2013-08-29 18:20:06.919318] [Dispatcher] Orig: 0x1103 | Cmd: 0x7007 | Param: 0
[2013-08-29 18:20:06.952946] >>[29/8/13 - 18:20:14]
[2013-08-29 18:40:07.004340] [Dispatcher] Orig: 0x1103 | Cmd: 0x7007 | Param: 0
[2013-08-29 18:40:07.036649] >>[29/8/13 - 18:40:14]
\end{verbatim}

El registro obtenido en la consola muestra como de manera exacta cada 20 minutos se ejecuta el comando \texttt{0x7007} aquevalente a \texttt{rtc\_print} proveniente del módulo \texttt{0x1103} que identifica a \texttt{taskFlightPlan} y como resultado se muestra en pantalla la hora leída desde el RTC del satélite.

En la figura \ref{ch5:figure:result:flightplan} se ha graficado toda la serie de comandos ejecutados durante la prueba y que provienen de este módulo con lo cual se comprueba la ejecución precisa y periódica del plan de vuelo configurado.

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/plot_fplan.png}{scale=0.7}{Gráfico de funcionamiento del plan de vuelo}{ch5:figure:result:flightplan}{ht!}

De este modo se comprueba el correcto funcionamiento de este módulo que ofrece una manera flexible y configurable para programar la ejecución de comandos en momentos específicos de la órbita.

\paragraph{Obtener el estado del sistema.}
Las variables de estado son actualizadas periódicamente en el módulo \texttt{taskHousekeeping} cada 20 segundos a través del comandos \texttt{drp\_updateAll\_dat\_CubesatVar}. Asimismo su valor se despliega a través de la consola serial cada 1 minuto y se obtiene un registro con el valor de todas las variables:

\begin{verbatim}
 ===================================
 Contenido de CubestatVar:
 ===================================
 ppc_opMode= 1
 ppc_lastResetSource= 4
 ppc_hoursAlive= 0
 ppc_hoursWithoutReset= 0
 ppc_resetCounter= 1
 ppc_enwdt= 1
 ppc_osc= 3
 ppc_MB_nOE_USB_nINT_stat= 0
 ppc_MB_nOE_MHX_stat= 1
 ppc_MB_nON_MHX_stat= 0
 ppc_MB_nON_SD_stat= 0
 -----------------------------------
 dep_ant_deployed= 1
 dep_ant_tries= 3
 dep_year= 13
 dep_month= 8
 dep_week_day= 6
 dep_day_number= 23
 dep_hours= 20
 dep_minutes= 34
 dep_seconds= 13
 -----------------------------------
 rtc_year= 13
 rtc_month= 8
 rtc_week_day= 6
 rtc_day_number= 23
 rtc_hours= 20
 rtc_minutes= 35
 rtc_seconds= 19
 -----------------------------------
 eps_bat0_voltage= 172
 eps_bat0_current= 902
 eps_bus5V_current= 1023
 eps_bus3V_current= 1023
 eps_bus_battery_current= 1023
 eps_bat0_temp= 559
 eps_panel_pwr= 0
 eps_status= -16384
 eps_soc= 8
 eps_socss= 8
 eps_state_flag= 2
 eps_charging= 1
 -----------------------------------
 trx_frec_tx= -14510
 trx_frec_rx= -16448
 trx_opmode= 16
 trx_temp_hpa= 2164
 trx_temp_mcu= 1150
 trx_rssi= -53 dBm
 trx_beacon_pwr= 1
 trx_telemetry_pwr= 1
 trx_status_tc= 0
 trx_count_tm= 0
 trx_count_tc= 0
 trx_lastcmd_day= -1
 -----------------------------------
 trx_newTcFrame= 0
 trx_newCmdBuff= 0
 fpl_index= -1
 msd_status= 1
 -----------------------------------
\end{verbatim}

Para comprobar la correcta actualización de las variables de estado durante el funcionamiento del satélite se ha tomado un set de ellas y se grafica su valor en el tiempo lo cual se muestra en la figura \ref{ch5:figure:result:status_var}. 

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/plot_status_var.png}{scale=0.7}{Gráfico con el valor de las variables de estado en el tiempo}{ch5:figure:result:status_var}{ht!}

El set de variables consideradas en el gráfico tiene por objetivo mostrar el funcionamiento en el tiempo del repositorio de estados más que un análisis exhaustivo de las implicaciones de sus valores instantáneos. Los resultados muestran como este repositorio permite mantener actualizado el estado de funcionamiento del satélite retro-alimentando al resto de los módulos de software con esta información. Acá se almacenan variables con información instantánea como el caso de los voltajes y corrientes en el sistema de energía o en nivel de RSSI presente el sistema de comunicaciones. Otras variables son modificadas de manera periódica como la hora actual del sistema o la cantidad de horas totales de funcionamiento. Algunas variables representan configuraciones de funcionamiento del satélite y no varían a menos que se instruya una modificación manual de ellas como el caso de las potencias de transmisión de telemetría y \textit{beacon} del \textit{transcevier} abordo.

Es muy importante que ciertas variables se mantengan entre cada reinicio del sistema para poder que el software de vuelo retome su estado anterior de funcionamiento ante una falla o \textit{reset}. Esto se comprueba en las pruebas de reinicio verificando el valor de las siguientes variables: \texttt{ppc\_lastResetSource}, \texttt{ppc\_hoursAlive}, \texttt{ppc\_hoursWithoutReset}, \texttt{ppc\_resetCounter} y \texttt{dep\_ant\_deployed}. La información se resume en el gráfico de la figura \ref{ch5:figure:result:status_var_reset}

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/plot_status_reset.png}{scale=0.7}{Variables de estado ante un reinicio}{ch5:figure:result:status_var_reset}{ht!}


En el gráfico se observa que ciertas variables se van actualizando con el tiempo como el caso de las horas de funcionamiento y las horas sin reinicio. Las pruebas de \textit{reset} comienzan a las 19:44 [Hrs] lo cual se refleja en el valor de las variables \texttt{ppc\_hoursWithoutReset} y \texttt{ppc\_resetCounter} que indican la cantidad de horas en que el sistema ha funcionado sin reiniciarse y el contador de estos eventos respectivamente. La prueba incluye diferentes tipos de reinicio (por software, por hardware o por \textit{watchdog}) los cuales se observan en la variable \texttt{ppc\_lastResetSource} a la vez que el contador va aumentado. La prueba del buen funcionamiento del sistema ante estos eventos es que el valor de las variables de estado sigue siendo coherente cada vez que el sistema se vuelve a iniciar como se ve en el valor del indicador del despliegue de antenas (\texttt{dep\_ant\_deployed}), el contador de reinicio y la cantidad total de horas de funcionamiento.

\paragraph{Inicio del sistema.}
El inicio del sistema cuenta de dos etapas. En la primera se inician funciones de bajo nivel como configuraciones de periféricos del procesador, puertos de entrada-salida, instanciar variables del sistema operativo e iniciarlo. De la correcta ejecución de esta etapa depende la posibilidad de contar con la salida serial para la consola por lo que se comprueba su funcionamiento a través su registro:

\begin{verbatim}
--------- SUCHAI BOOT SEQUENCE ---------

Initializing sattelite bus
    * Microcontroller IO pins
    * CubesatKit MB
    * PC104 Bus

Initilizing Microcontroller
    * Reset status
    * Setting oscillator
    * mPWRMGNT_Regulator_ActiveInSleep
    * Enabling WDT

Starting FreeRTOS [->]
>>[Executer] Started
>>[Dispatcher] Started
>>[Deployment] Started
\end{verbatim}

Desde este momento se inicia la segunda etapa de inicio implementada en \texttt{taskDeployment}, en este punto ya se cuenta con todas las funcionalidades de bajo nivel y el sistema operativo funcionando así que se procede al inicio de todas la funciones de la capa de aplicación del software de vuelo incluyendo: periféricos externos, repositorios, estructuras de datos y el resto de los \textit{listeners}. En esto momento se ejecuta el periodo de inactividad si corresponde así como el despliegue de antenas. La salida por consola es incremental a cada función que realiza este módulo y demuestra la correcta ejecución de la secuencia de inicio:

\begin{verbatim}
[Deployment] INITIALIZING SUCHAI FLIGHT SOFTWARE

[dep_init_Peripherals] Initializig external pheripherals...
    * External RTC
    * EEPROM Memories
    * SD Memory  [delay]
    * SD Memory [init OK]
    * SD Memory [onReset]  dat_onReset_memSD()..
    Static structures..
    DAT_Payload()..
    DAT_GnrlPurpBuff()..

[dep_init_Repos] Initializing data repositories...
    * FlighPlan
    * Telecommands buffer
    * Payloads status rep.
    * Status rep.
        - LastResetSouce: SOFTWARE_Reset
            - NOT the First time on! resetCounter++
            - resetCounter = 6
    * Commands rep.

[dep_init_GnrlStruct] Initializing other structures...
    * init EPS structs

[dep_silent_time] Mandatory inactivity time...
    Satellite launched. Antenna deployed
    FINISHING SILENT TIME

[dep_deploy_antenna] Deploying TRX Antenna... 
    * Antenna is already deployed
    * Setting TRX
Setting beacon: SUCHAIATINGDOTUCHILEDOTCL-
>> TRX Setting BEACON:
      Setting Offset...
      Setting Content... 
      Setting Beacon Length... 26

[dep_launch_tasks] Starting all tasks...
    * Creating taskConsole
    * Creating taskHousekeeping
    * Creating taskCommunications
    * Creating taskFlightPlan
[Deployment] ENDS
[Deployment] Deleting task
\end{verbatim}

La salida anterior demuestra también la capacidad del software para recordar el estado anterior a su reinicio, ya que es capaz de determinar si es la primera vez que se inicia para proceder al periodo de inactividad y despliegue de antenas si corresponde.

Al final de esta secuencia se inician el resto de los \textit{listenrs} y comienzan su ejecución en segundo plano. El éxito de la operación de inicio se logra al visualizar el \textit{prompt} de la consola serial que está lista para recibir comandos y registrar los sucesos del software de vuelo:

\begin{verbatim}
>>[Console] Started
______________________________________________________________________________
                     ___ _   _  ___ _  _   _   ___ 
                    / __| | | |/ __| || | /_\ |_ _|
                    \__ \ |_| | (__| __ |/ _ \ | | 
                    |___/\___/ \___|_||_/_/ \_\___|
______________________________________________________________________________

>>[Comunications] Started
>>[FlightPlan] Started
>>[Houskeeping] Started

\end{verbatim}

\subsubsection{Área de energía}
\paragraph{Estimación de la carga de la batería.}
La estimación de carga de baterías está a cargo del controlador de la EPS y su estimación se actualiza de manera periódica como parte de las tareas del \textit{listener} de \textit{taskHousekeeping} cada 20 segundos. El parámetro denominado SOC (\textit{State Of Charge}) es una variable de estado del sistema y se calcula a partir de los datos de consumo de energía, temperatura y voltaje que reporta la EPS. Esta variable es utilizada por el sistema para determinar si un comando se puede ejecutar o no. Las lecturas de los sensores del sistema de energía fueron registrados cada cinco minutos durante la prueba y su resultado se observa en la figura \ref{ch5:figure:result:eps_var}

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/plot_eps_var.png}{scale=0.7}{Gráfico con variables de EPS}{ch5:figure:result:eps_var}{ht!}

Se registraron además los valores de energía, voltaje y temperatura de la EPS así como el nivel de SOC calculado. La tabla \ref{ch5:figure:result:soc} muestra los resultados obtenidos, así como la estimación del SOC calculados a \textit{posteriori} para comprobar la operación realizada en el computador a bordo del satélite.

%[1: ruta imagen, 2: medida, 3: caption, 4: label, 5: posicion]
\figura{img/plot_soc.png}{width=0.95\textwidth}{Gráfico de estimación de SOC}{ch5:figure:result:soc}{ht!}

\paragraph{Presupuesto de energía.}
EL nivel de SOC como variable de estado indicará la energía que se dispone para ejecutar comandos en el sistema. El encargado de velar por el cumplimiento del presupuesto energético es el módulo \textit{Dispatcher} quien realiza una comparación entre la energía requerida por un comando y la energía disponible en ese momento.

Durante la operación se lleva a cabo el test de SOC donde de manera artificial se cambian los requerimientos energéticos de una serie de comandos a niveles mayores al de la energía disponible y se intenta su ejecución. El comando correspondiente es el \texttt{0x8006} o \texttt{tcm\_set\_sysreq} que afecta a todos los comandos del grupo \texttt{TCM} que contiene funciones encargadas de generar telemetría y \textit{beacons} cambiando el nivel de energía que requieren al valor ingresado por el usuario. En la consola serial queda registrado la elevación de los requerimientos de energía de este grupo a 10 mientras que el SOC del sistema es 4:

\begin{verbatim}
[2013-08-29 20:17:59.701281] SOC= 4
[2013-08-29 20:18:10.788012] exe_cmd 0x8006 10
[2013-08-29 20:18:10.823338] [Console] Se genera comando: 0x8006
[2013-08-29 20:18:10.860289] [Dispatcher] Orig: 0x1101 | Cmd: 0x8006 | Param: 10
[2013-08-29 20:18:10.890811] [Dispatcher] CMD Result: 1
\end{verbatim}

Así cuando se intenta ejecutar un comando del grupo \texttt{0x8000} estos son rechazados por el \textit{Dispatcher} evitando su ejecución:

\begin{verbatim}
[2013-08-29 20:19:10.667124] exe_cmd 0x8000 0
[2013-08-29 20:19:10.825339] [Console] Se genera comando: 0x8000
[2013-08-29 20:19:10.864141] [Dispatcher] Command: 0x8000 | From: 0x1101 Refused because of SOC 
[2013-08-29 20:19:11.197873] [Dispatcher] Orig: 0x1102 | Cmd: 0x3007 | Param: 0
[2013-08-29 20:19:11.231369] [Dispatcher] CMD Result: 1
\end{verbatim}

Esta situación no solo ocurre bajo condiciones de prueba, puede ocurrir que tras algunas operaciones que demandan grandes cantidades de energía el nivel de SOC disminuya quedando bajo el umbral que requieren los comandos. Este es el caso de las transmisiones de telemetría y \textit{beacons} como se observa en el siguiente registro donde luego de dos envíos de telemetría el nivel de SOC baja a 3 causando que una posterior solicitud de descarga de datos sea rechazada:

\begin{verbatim}
[2013-08-29 20:08:56.149539] com_doOnRSSI..
[2013-08-29 20:08:56.171706] [Dispatcher] Orig: 0x1102 | Cmd: 0x8003 | Param: 2
[2013-08-29 20:08:56.221945] >> Sending START_WRITE_TM command... 
[2013-08-29 20:08:58.031927] >> Sending START_SEND_TM command...
[2013-08-29 20:08:58.798705] >> Telemetry transmited [OK]

[2013-08-29 20:08:58.854076] >> Sending START_WRITE_TM command... 
[2013-08-29 20:09:01.352976] >> Sending START_SEND_TM command...
[2013-08-29 20:09:02.133597] >> Telemetry transmited [OK]

[2013-08-29 20:09:02.414715] [Dispatcher] Orig: 0x1104 | Cmd: 0x5000 | Param: 0
[2013-08-29 20:09:02.429875] drp_updateAll_dat_CubesatVar()..
[2013-08-29 20:09:02.710113] SOC= 3

[2013-08-29 20:09:06.121742] RSSI_CNT=2
[2013-08-29 20:09:08.138337] RSSI_CNT=4
[2013-08-29 20:09:10.146584] RSSI_CNT=6
[2013-08-29 20:09:12.197035] RSSI_CNT=8
[2013-08-29 20:09:14.152838] RSSI_CNT=10
[2013-08-29 20:09:16.140583] RSSI_CNT=12
[2013-08-29 20:09:18.140335] com_doOnRSSI..
[2013-08-29 20:09:18.158957] [Dispatcher] Command: 0x8003 | From: 0x1102 Refused because of SOC 
\end{verbatim}


La tabla \ref{ch5:table:test_soc} resume los resultados de la prueba de SOC.

\begin{table}[ht!] \caption{Resultados para test SOC}
\centering
\begin{tabular}{llllll}
\hline
\textbf{Hora} & \textbf{Comando} & \textbf{Nombre} & \textbf{SysReq} & \textbf{SOC} & \textbf{Resultado} \\ \hline
20:18:10 & 0x8006 & tcm\_set\_sysreq & 1 & 4  & Ejecutado \\
20:18:19 & 0x5000 & drp\_updateAll\_dat\_CubesatVar & 1 & 4  & Ejecutado \\
20:18:33 & 0x300C & trx\_tm\_trxstatus   & 4 & 4  & Ejecutado \\
20:19:10 & 0x8000 & tcm\_testframe & 10 & 4  & Rechazado \\
20:19:13 & 0x8000 & tcm\_testframe & 10 & 4  & Rechazado \\
20:19:19 & 0x8002 & tcm\_send\_beacon & 10 & 4  & Rechazado \\
20:19:19 & 0x5000 & drp\_updateAll\_dat\_CubesatVar & 1 & 4  & Ejecutado \\
20:19:45 & 0x8003 & tcm\_sendTM\_cubesatVar & 10 & 4  & Rechazado \\
20:20:03 & 0x8003 & tcm\_sendTM\_cubesatVar & 10 & 4  & Rechazado \\ \hline
\end{tabular} \label{ch5:table:test_soc}
\end{table}

Se observa que el control realizado por \texttt{Dispatcher} aplica efectivamente las indicaciones del presupuesto de energía planificado, el cual se expresa en el parámetro SOC y la cantidad de energía que requiere cada comando a ejecutar. Durante la prueba todos los comandos que requieren al menos el nivel de energía disponible fueron ejecutados mientras que aquellos con requerimientos superiores fueron rechazados.

El \textit{power budget} se aplica a diferentes niveles dentro del sistema que representa el satélite, la parte que corresponde al software de vuelo tiene relación con la estimación de la cantidad de energía disponible en base a los parámetros de voltaje, corriente y temperatura que entrega la EPS así como evitar la ejecución de comandos que requieren más recursos energéticos que los disponible que es el ámbito que cubre esta prueba. El resto de la planificación energética queda por parte del equipo de operación del sistema en cuanto a determinar la cantidad de energía correcta para cada comando, la frecuencia de ejecución de aquellos de alto consumo como el envío de \textit{beacon} o la correcta programación del plan de vuelo.

\subsubsection{Órbita}
\paragraph{Actualizar parámetros de órbita.}
En esta versión del software de vuelo no se contemplan métodos de estimación de órbita y se relega esta requerimiento al operador del satélite. En tierra se puede realizar la propagación de órbita obtener una relación entre el plan de vuelo del satélite y su posición orbital para así programar las operaciones requeridas en momentos determinados.

\subsubsection{\textit{Payloads}}
\paragraph{Ejecución de comandos de \textit{payloads}}.
En esta versión del software de vuelo y dada las características de los \textit{payloads} que van a bordo, la capacidad de ejecutar determinadas acciones de \textit{payloads} puede ser completamente programada a través del plan de vuelo si se proveen los comandos pertinentes a cada uno. No obstante, la integración a nivel de \textit{payloads} del satélite y sus resultados se puede encontrar en la memoria \textit{Proceso de diseño, arquitectura y testeo del nano-satelite SUCHAI}\cite{TOOPAZO}.


